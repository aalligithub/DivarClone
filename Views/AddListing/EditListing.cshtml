@model DivarClone.Models.Listing

@if (ViewBag.ModelStateErrors != null)
{
    <div class="alert alert-danger">
        <pre>@ViewBag.ModelStateErrors</pre>
    </div>
}

@if (TempData["SuccessMessage"] != null)
{
	<div class="alert alert-success">
		@TempData["SuccessMessage"]
	</div>
}

@{
	var categories = Enum.GetValues(typeof(Category)).Cast<Category>();
	
	int allowedNumberOfImages = 6;

	if (!Model.ImagePath.FirstOrDefault().Contains("No_Image_Available.jpg"))
	{
		allowedNumberOfImages = 6 - Model.ImageData.Count;
	}
}

<style>
	.custom-file-upload {
		display: inline-block;
		position: relative;
		margin-bottom: 10px;
	}

	.custom-file-upload button {
		background-color: #dc3545; /* Customize the button color */
		color: white;
		padding: 8px 16px;
		border: none;
		cursor: pointer;
		border-radius: 5px;
	}

	#customLabel1, #customLabel2, #customLabel3 {
		margin-left: 10px;
		font-size: 14px;
		color: #555; /* Customize label color */
	}

	label {
		font-size:25px ;
		margin-bottom:2vh ;
	}

	/* Styling for the container */
	.file-upload-container {
		text-align: center;
		margin: 10px 0;
	}

	/* Button styling */
	.upload-btn {
		background-color: #007bff;
		color: #fff;
		border: none;
		padding: 8px 15px;
		border-radius: 5px;
		cursor: pointer;
		font-size: 1rem;
		display: inline-block;
		margin-top: 5px;
		transition: background-color 0.3s ease;
	}

	.upload-btn:hover {
		background-color: #0056b3;
	}

	/* Label styling */
	.file-label {
		display: block;
		font-size: 0.9rem;
		color: #555;
		margin-top: 8px;
	}

	/* Container to center the button */
	.submit-container {
		display: flex;
		justify-content: center;
		margin-top: 20px;
	}

	/* Button styling */
	.submit-btn {
		background-color: #28a745; /* Green color */
		color: #fff;
		border: none;
		width: 200px;
		height: 45px;
		font-size: 1rem;
		border-radius: 8px;
		cursor: pointer;
		transition: background-color 0.3s ease, transform 0.2s ease;
	}

	/* Hover effect */
	.submit-btn:hover {
		background-color: #218838; /* Darker green */
		transform: scale(1.05); /* Slightly increase button size */
	}

	/* Active (click) effect */
	.submit-btn:active {
		transform: scale(0.95); /* Slightly decrease size */
	}

</style>

<div class="container" >
    <div class="row" style="height:100%;">
		<div class="col alert alert-secondary" style="margin-right:25px; box-shadow:0px 0px 2px gray;">

			<form asp-action="Update" enctype="multipart/form-data" method="post">
				<div class="mb-4">
					<label for="Name">تیتر آگهی</label>
					<input class="form-control" type="text" id="Name" name="Name" placeholder="نام" asp-for="Name" />
				</div>

				<div class="mb-4">
					<label for="Description">توضیحات آگهی</label>
					<textarea class="form-control" id="Description" name="Description" placeholder="توضیحات" asp-for="Description">Description</textarea>
				</div>

				<div class="mb-4">
					<label for="Price">قیمت</label>
					<input class="form-control" type="text" id="Price" name="Price" placeholder="قیمت" asp-for="Price" />
				</div>

				<div class="mb-4">
					<label for="Category">دسته بندی</label>
					<select id="Category" name="Category" class="form-select" asp-for="Category">
						<option value="null">انتخاب کنید</option>
						<option value="0">وسایل برقی</option>
						<option value="1">املاک</option>
						<option value="2">وسایل نقلیه</option>
					</select>
				</div>

				@if (allowedNumberOfImages > 0) {
					<div class="alert alert-success" style="box-shadow: 0px 0px 3px gray;">
						<h5 style="text-align:center;">شما اجازه آپلود @allowedNumberOfImages عکس را دارید</h5>
					</div>

					<div class="row">

						@for (int i = 0; i < allowedNumberOfImages; i++)
						{
							<div class="col-md-4 file-upload-container">
								<input type="file" id="ImageFile@(i)" name="ImageFiles" style="display: none;" onchange="updateLabel(@(i))" multiple>
								<button type="button" class="upload-btn" onclick="document.getElementById('ImageFile@(i)').click()">
									📂 انتخاب فایل
								</button>
								<label for="ImageFile@(i)" id="customLabel@(i)" class="file-label">فایل را انتخاب کنید</label>
							</div>
						}

					</div>
				} else {
					<div class="alert alert-danger" style="box-shadow: 0px 0px 3px gray;">
						<h5 style="text-align:center;">آگهی حداکثر تعداد عکس ها را دارد در صورت تمایل از عکس ها حذف کنید</h5>
					</div>
				}

				<input type="hidden" asp-for="Poster" value="@User.Identity.Name" />
				<input type="hidden" asp-for="Id" value="@Model.Id" />

				<div class="submit-container">
					<button type="submit" class="submit-btn" onclick="checkInput()">ثبت</button>
				</div>

			</form>

        </div>
		<div class="col">
			<div class="row">
			@if (allowedNumberOfImages != 6)
			{
				@for (var i = 0; i < Model.ImageData.Count; i++)
				{
					var image = Model.ImageData[i];
					var path = Model.ImagePath[i];
					var id = i;

					<div class="col-4 card m-2" id="image-@id" style="width: 18rem; box-shadow:0px 0px 2px gray;">
						<img class="mySlides-@Model.Id" src="@image" alt="no img" style="margin-top:25px; width: 100%; height: auto; object-fit:contain; box-shadow:0px 0px 2px black" />
						<div class="card-body">
							<button onclick="deleteListingImage('@path', '@id')">حذف عکس</button>
						</div>
					</div>
				}
			}
			</div>
		</div>
    </div>
</div>
<script>
	function deleteListingImage(imagePath, id) {
		var userConfirmed = confirm("از بابت حذف این عکس مطمعن هستید؟");

		if (userConfirmed) {
			console.log(imagePath);
			$.ajax({
				url: "@Url.Action("DeleteListingImage", "AddListing")", // Ensure the URL is correct
				type: "POST",
				data: {
					imagePath: imagePath
				},
				success: function (result, status, xhr) {
					alert("عکس با موفقیت پاک شد ، Status: " + status + " " + xhr.status + " " + xhr.statusText);
					
					// $('#image-'+ id).remove();
					location.reload();
				},
				error: function (xhr, status, error) {
					alert("عکس پاک نشد. Status: " + status + " Error: " + error + " " + xhr.status + " " + xhr.statusText);
					console.error("Error details:", xhr.responseText);
				}
			});
		}
	}

	function updateLabel(index) {
		var fileInput = document.getElementById('ImageFile' + index);
		var label = document.getElementById('customLabel' + index);

		// Check if files are selected
		if (fileInput.files.length > 0) {
			label.innerText = fileInput.files.length > 1
				? fileInput.files.length + ' فایل انتخاب شد' // For multiple files
				: fileInput.files[0].name; // For a single file
		} else {
			label.innerText = 'هیچ فایلی انتخاب نشده است'; // Default message
		}
	}
</script>