@using Microsoft.AspNetCore.Identity
@using DivarClone.Areas.Identity.Data
@using Microsoft.JSInterop

@inject SignInManager<DivarCloneUser> SignInManager
@inject UserManager<DivarCloneUser> UserManager
@inject IJSRuntime jsRuntime

@{
    ViewData["Title"] = "دیوار";
}
@model IEnumerable<DivarClone.Models.Listing>


<h1 class="custom-font mb-3" id="title-header">آگهی ها</h1>
<div class="row">
    @if (User.Identity.IsAuthenticated)
    {
        <div class="col-md-10" id="listingCardContainer">
            <div class="row" id="listingCard"></div>
            <div id="listingForm"></div>
        </div>

        <div id="PartialZoneUserControl" class="col-md-2"></div>

    } else  {
        <div class="row" id="listingCard"></div>
    }
</div>
@section Scripts{
    <script>
        $('#PartialZoneUserControl').load("/Home/UserControlPartial")
    </script>

    <script>
        document.getElementById("listingCard").innerHTML += (`
        @if (!Model.Any())
        {
            <p>آگهی یافت نشد</p>
        } else {
            @await Html.PartialAsync("_ListingPartial", Model)
        }`)

    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (window.location.href.includes('Secret')) {
                document.getElementById("title-header").innerText = "آگهی های خاص";
            }
        });

        function confirmDelete(listingId) {
            var userConfirmed = confirm("از بابت حذف این آگهی مطمعن هستید؟");

            if (userConfirmed) {
                // window.location.href = `@Url.Action("DeleteUserListing", "Home")?id=${listingId}`;
                $.ajax({
                    url: '@Url.Action("DeleteUserListing", "Home")',
                    type: 'GET',
                    data: { id: listingId },
                    success: function (result) {
                        $('#listingCard').html(result);
                    },
                    error: function () {
                        alert("آگهی مورد نظر حذف نشد");
                    }
                });
            }
        }

        function editListing(listingId) {
            var userConfirmed = confirm("از ویرایش این آگهی مطمعن هستید؟");

            if (userConfirmed) {
                window.location.href = `@Url.Action("EditListing", "AddListing")?id=${listingId}`;
            }
        }

        function filterByText(text) {
            $.ajax({
                url: '@Url.Action("SearchResults", "Home")',
                type: 'GET',
                data: { textToSearch: text },
                success: function (result) {
                    $('#listingCard').html(result);
                },
                error: function () {
                    alert("آگهی مورد نظر یافت نشد");
                }
            });
        }

        function filterByCategory(category) {
            $.ajax({
                url: '@Url.Action("FilterResults", "Home")',
                type: 'GET',
                data: { category: category },
                success: function (result) {
                    $('#listingCard').html(result);
                },
                error: function () {
                    alert("آگهی مورد نظر یافت نشد");
                }
            });
        }
	</script>
}